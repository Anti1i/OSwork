#!/bin/bash

#################################################################################################################
# Usage:
#        ./genlog
# Note:
#	 extract syslog from disk and print content directly
# Modified: 精简版 - 仅提取+打印日志，移除所有画图相关功能 2025-12-30
#################################################################################################################

# ===================== 配置区（可根据实际情况修改）=====================
IMG_FILE="./80m.img"          # 镜像文件路径
SYSLOG_FILE="./LOSG"     # 提取的日志文件（保留备份）
TMP_FILE="/tmp/prntdisk.tmp" # 临时文件
HEX_SKIP="1C88000"            # 十六进制偏移地址

# ===================== 前置检查 ======================
# 检查镜像文件是否存在
if [ ! -f "$IMG_FILE" ]; then
    echo -e "\033[31m[ERROR]\033[0m 镜像文件 $IMG_FILE 不存在！请确认文件路径"
    exit 1
fi

# 检查镜像文件是否可读
if [ ! -r "$IMG_FILE" ]; then
    echo -e "\033[31m[ERROR]\033[0m 无权限读取 $IMG_FILE！执行: chmod 644 $IMG_FILE"
    exit 1
fi

# ===================== 核心逻辑 - 提取日志 ======================
echo -e "\033[32m[INFO]\033[0m 开始从镜像提取系统日志..."
echo "---------------------------------------------------"

# 十六进制偏移转十进制
skip=$(echo "obase=10;ibase=16;$HEX_SKIP" | bc)

# 读取日志长度
dd if="$IMG_FILE" of="$TMP_FILE" bs=1 count=32 skip="$skip" 2>/dev/null
if [ $? -ne 0 ]; then
    echo -e "\033[31m[ERROR]\033[0m 读取日志长度失败！请检查偏移地址是否正确"
    rm -f "$TMP_FILE"
    exit 1
fi

# 获取有效长度（兼容二进制数据，自动兜底）
log_count=$(head -n 1 "$TMP_FILE" | sed 's/[^0-9]//g')
if [ -z "$log_count" ] || [ "$log_count" -eq 0 ]; then
    log_count=1024000
fi

# 读取核心日志内容
dd if="$IMG_FILE" of="$SYSLOG_FILE" bs=1 count="$log_count" skip="$skip" 2>/dev/null

# ===================== 核心操作 - 打印日志内容 ======================
if [ -s "$SYSLOG_FILE" ]; then
    echo -e "\033[32m✅ 日志提取成功，完整日志内容如下：\033[0m"
    echo "==================================================="
    # 直接打印提取到的全部日志内容（核心需求）
    cat "$SYSLOG_FILE"
    echo "==================================================="
    echo -e "\033[32m✅ 日志打印完成！日志已备份至文件：$SYSLOG_FILE\033[0m"
else
    echo -e "\033[31m[ERROR]\033[0m 日志提取失败，日志文件为空！请核对偏移地址 $HEX_SKIP"
    rm -f "$TMP_FILE" "$SYSLOG_FILE"
    exit 1
fi

# ===================== 收尾清理 ======================
rm -f "$TMP_FILE"  # 自动清理临时文件，无残留
echo

exit 0
